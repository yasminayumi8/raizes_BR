{% extends "base.html" %}

{% block title %}Cadastro de Movimentação{% endblock %}

{% block head_extras %}
    <link rel="stylesheet" href="{{ url_for('static', filename='movimentacao.css') }}">
{% endblock %}

{% block content %}
<div class="container my-5">
    <h2 class="text-center mb-4">Cadastro de Movimentação</h2>
    <form id="formMovimentacao" class="p-4 border rounded shadow bg-light">
        <div class="mb-3">
            <label for="quantidade" class="form-label">Quantidade</label>
            <input type="number" id="quantidade" class="form-control" required>
        </div>

        <div class="mb-3">
            <label for="produto_id" class="form-label">Produto</label>
            <input type="number" id="produto_id" class="form-control" placeholder="ID do produto" required>
        </div>

        <div class="mb-3">
            <label for="data" class="form-label">Data</label>
            <input type="date" id="data" class="form-control" required>
        </div>

        <div class="mb-3">
            <label for="status" class="form-label">Status</label>
            <select id="status" class="form-select" required>
                <option value="">Selecione...</option>
                <option value="true">Entrada</option>
                <option value="false">Saída</option>
            </select>
        </div>

        <div class="mb-3">
            <label for="usuario_id" class="form-label">Usuário</label>
            <input type="number" id="usuario_id" class="form-control" placeholder="ID do usuário" required>
        </div>

        <button type="submit" class="btn btn-success w-100">
            <i class="bi bi-save"></i> Salvar Movimentação
        </button>
    </form>

    <div id="mensagem" class="mt-3"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById("formMovimentacao").addEventListener("submit", async function (e) {
    e.preventDefault();

    const dados = {
        quantidade: parseInt(document.getElementById("quantidade").value),
        produto_id: parseInt(document.getElementById("produto_id").value),
        data: document.getElementById("data").value,
        status: document.getElementById("status").value === "true",
        usuario_id: parseInt(document.getElementById("usuario_id").value)
    };

    try {
        const resposta = await fetch("http://127.0.0.1:5003/cadastro/movimentacao", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                // Esta rota exige token e ADM
                "Authorization": "Bearer " + localStorage.getItem("token")
            },
            body: JSON.stringify(dados)
        });

        const resultado = await resposta.json();

        if (resposta.ok) {
            document.getElementById("mensagem").innerHTML =
                `<div class="alert alert-success">Movimentação cadastrada com sucesso! ID: ${resultado.ID_movimentacao}</div>`;
            document.getElementById("formMovimentacao").reset();
        } else {
            document.getElementById("mensagem").innerHTML =
                `<div class="alert alert-danger">Erro: ${resultado.mensagem || resultado.erro || "Não foi possível salvar."}</div>`;
        }
    } catch (erro) {
        document.getElementById("mensagem").innerHTML =
            `<div class="alert alert-danger">Erro de conexão com a API.</div>`;
    }
});
</script>
{% endblock %}